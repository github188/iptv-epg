<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="page-view-size" content="1280*720">
	<title>Play Page</title>
</head>
<body bgcolor="black">

	<script src="../assets/debug/alloy_lever.js"></script>
	<script>
		Authentication.CUSetConfig('ChannelCount', 1);
		Authentication.CUSetConfig('Channel','ChannelID="1",ChannelName="CCTV-1",UserChannelID="1",ChannelURL="igmp://224.1.1.54:10392",TimeShift="1",TimeShiftLength="10800",ChannelSDP="igmp://224.1.1.54:10392",TimeShiftURL="",ChannelType="1",IsHDChannel="2",PreviewEnable="0",ChannelPurchased="0",ChannelLocked="0",ChannelLogURL="",PositionX="null",PositionY="null",BeginTime="null",Interval="null",Lasting="null",ActionType="1",FCCEnable="0",ChannelFECPort="0"');

		function debug(str) {
			console.log(str);
		}

		// 播放器对象
		function MediaPlayController() {
		    
		    this.mediaStr = '';
		    this.playUrl = '';
		    this.channelNo = '';
		    this.mp = null;
		    this.replayTimer = null;
		}

		MediaPlayController.prototype.init = function () {
		    
		    this.initMediaPlay();

		    return this;
		};

		// 虚拟事件处理
		MediaPlayController.prototype.virtualEventHandler = function () {

		    var eventJson = Utility.getEvent();

		    // 这里可能会报错，因为底下传上来的的 
		    // event json 中的 key 没有带引号，JSON.parse 会解析错误
		    // eventJson = JSON.parse(eventJson);
		    eventJson = eval('(' + eventJson + ')');

		    var type = eventJson.type;

		    this.error('virtualEventHandler code type: ' + type);
		    switch (type) {
		        case 'EVENT_MEDIA_BEGINNING':   // 视频开始播放
		            break;
		        case 'EVENT_MEDIA_END':     // 视频播放结束
		            this.play(this.playUrl);
		            break;
		        case 'EVENT_MEDIA_ERROR':   // 视频播放错误
		            break;
		        default:return false;break;
		    }

		    return false;
		};

		// 频道列表错误处理
		MediaPlayController.prototype.error = function (msg, code, handler) {

		    var errorContent = '',
		        width = 350,
		        left = (document.body.clientWidth - width) / 2;

		    errorContent = '<div id="mp-error-tips" style="position:absolute;'
		        + 'left:' + left
		        + 'px;top:40%;'
		        + 'width:' + width 
		        + 'px;background-color:gray;border-radius:2px;'
		        + 'text-align:center;line-height:80px;color:white;font-size:22px;'
		        + '">'
		        + '<i class="fa fa-exclamation-triangle" aria-hidden="true"></i>'
		        + '&nbsp;&nbsp;' + msg
		        + '</div>';

		    var div = document.createElement('div');
		    document.body.appendChild(div);
		    div.innerHTML = errorContent;

		    // $('body').append($(errorContent));

		    setTimeout(function () {
		        div.parentNode.removeChild(div);
		    }, 2000);
		};

		MediaPlayController.prototype.setMediaStr = function (playUrl) {
		    
		    if ( !playUrl ) { that.error('setMediaStr 频道地址不存在！'); return; }

		    this.playUrl = playUrl;

		    this.mediaStr = '[{mediaUrl:"' + playUrl + '",';
		    this.mediaStr += 'mediaCode: "jsoncode1",';
		    this.mediaStr += 'mediaType:2,';
		    this.mediaStr += 'audioType:1,';
		    this.mediaStr += 'videoType:1,';
		    this.mediaStr += 'streamType:1,';
		    this.mediaStr += 'drmType:1,';
		    this.mediaStr += 'fingerPrint:0,';
		    this.mediaStr += 'copyProtection:1,';
		    this.mediaStr += 'allowTrickmode:1,';
		    this.mediaStr += 'startTime:0,';
		    this.mediaStr += 'endTime:20000,';
		    this.mediaStr += 'entryID:"jsonentry1"}]';

		    return this;
		}

		// 获取或设值播放地址
		MediaPlayController.prototype.initMediaPlay = function () {

		    // this.setMediaStr(this.playUrl);
		    this.mp = new MediaPlayer(); //新建一个mediaplayer对象
		    var instanceId = this.mp.getNativePlayerInstanceID(); //读取本地的媒体播放实例的标识

		    var playListFlag = 0; //Media Player 的播放模式。 0：单媒体的播放模式 (默认值)，1: 播放列表的播放模式
		    var videoDisplayMode = 1; //MediaPlayer 对象对应的视频窗口的显示模式. 1: 全屏显示2: 按宽度显示，3: 按高度显示
		    var height = window.innerHeight;
		    var width = window.innerWidth;
		    var left = 0;
		    var top = 0;
		    var muteFlag = 0; //0: 设置为有声 (默认值) 1: 设置为静音
		    var subtitleFlag = 0; //字幕显示
		    var videoAlpha = 0; //视频的透明度
		    var cycleFlag = 0;
		    var randomFlag = 0;
		    var autoDelFlag = 0;
		    var useNativeUIFlag = 1;
		    //初始话mediaplayer对象
		    // alert("开始播放$$$");
		    this.mp.initMediaPlayer(instanceId, playListFlag, videoDisplayMode,
		        height, width, left, top, muteFlag, useNativeUIFlag, subtitleFlag, videoAlpha, cycleFlag, randomFlag, autoDelFlag);
		    // this.mp.setSingleMedia(this.mediaStr); //设置媒体播放器播放媒体内容
		    this.mp.setAllowTrickmodeFlag(0); //设置是否允许trick操作。 0:允许 1：不允许
		    this.mp.setVideoDisplayMode(0);
		    this.mp.setVideoDisplayArea(left, top, width, height);
		    this.mp.setNativeUIFlag(0); //设置播放器本地UI显示功能 0:允许 1：不允许
		    this.mp.setAudioTrackUIFlag(1);
		    this.mp.setMuteUIFlag(1);
		    this.mp.setAudioVolumeUIFlag(1);
		    this.mp.refreshVideoDisplay();
		    debug('mediaUrl: ' + playUrl);
		}

		MediaPlayController.prototype.stop = function () {
		    // this.mp.stop(1);
		    // this.mp.close();
		    this.mp.releaseMediaPlayer(this.mp.getNativePlayerInstanceID());
		    return this;
		}

		MediaPlayController.prototype.play = function (playUrl) {

		    debug('playUrl - play: ' + playUrl);

		    if ( !playUrl ) { this.error('play 频道地址不存在！'); return; }

		    var isChannelNo = !isNaN(playUrl);

		    // this.mp.stop(1);

		    debug('is joinChannel: ' + isChannelNo);

		    this.mp.joinChannel(playUrl);

		    // 设置播放地址
		    // this.setMediaStr(playUrl);
		    // this.mp.setSingleMedia(this.mediaStr); //设置媒体播放器播放媒体内容
		    // this.mp.playFromStart();

		    // this.setDisplayArea(200, 100, 500, 400);

		    return this;
		};

		// 设置播放位置和大小：mode(0: 非全屏，1：全屏)
		MediaPlayController.prototype.setDisplayArea = function (left, top, width, height) {
		    
		    this.mp.setVideoDisplayMode(0);
		    this.mp.setVideoDisplayArea(left, top, width, height);
		    // this.mp.refreshVideoDisplay();

		}


		var mpc = new MediaPlayController();

		// 
		// 'igmp://224.1.1.54:10392'
		var url = 'http://10.253.255.4/iptv/clist/vod/yanguiren.ts';

		mpc.init().play('1');

		console.log(Authentication.CUGetConfig('ChannelCount'));
		console.log(Authentication.CUGetConfig('Channel'));

		window.onkeydown = function (event) {

		    var keycode = event.which ? event.which : event.keycode;

		    mpc.error('onkeydown code: ' + keycode);

		    // 虚拟事件
		    if (keycode === 768) {
		        mpc.virtualEventHandler();
		        return false;
		    }

		    if (keycode === 8) {
		    	window.location.href = window.location.href;
		    }

		    return true;
		};

	</script>
</body>
</html>